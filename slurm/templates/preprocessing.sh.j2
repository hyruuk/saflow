{% extends "base.sh.j2" %}

{% block job_commands %}
# =============================================================================
# Preprocessing Pipeline
# =============================================================================

echo "Preprocessing Configuration:"
echo "  Subject:        {{ subject }}"
echo "  Run:            {{ run }}"
echo "  BIDS root:      {{ bids_root }}"
echo "  Log level:      {{ log_level }}"
echo "  Skip existing:  {{ skip_existing }}"
echo ""

# Run preprocessing
# --skip-report: subject-level aggregate report is handled by a separate
# dependent SLURM job (report_sub-XX) that runs after all runs complete.
python -m code.preprocessing.run_preprocessing \
    --subject {{ subject }} \
    --runs {{ run }} \
    --bids-root {{ bids_root }} \
    --log-level {{ log_level }} \
    {% if skip_existing %}--skip-existing{% else %}--no-skip-existing{% endif %} \
    --skip-report

PREPROC_EXIT=$?

if [ $PREPROC_EXIT -eq 0 ]; then
    echo "✓ Preprocessing completed successfully"
else
    echo "✗ Preprocessing failed with exit code $PREPROC_EXIT"
    exit $PREPROC_EXIT
fi

{% endblock %}
