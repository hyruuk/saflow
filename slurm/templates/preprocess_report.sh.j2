{% extends "base.sh.j2" %}

{% block job_commands %}
# =============================================================================
# Preprocessing Aggregate Report
# =============================================================================

echo "Report Configuration:"
{% if subject %}
echo "  Subject:        {{ subject }}"
{% endif %}
echo "  Dataset report:  yes (always regenerated)"
echo ""

{% if subject %}
# Generate subject-level report
python -m code.preprocessing.aggregate_reports -s {{ subject }}

SUBJECT_EXIT=$?
if [ $SUBJECT_EXIT -eq 0 ]; then
    echo "✓ Subject report generated successfully"
else
    echo "✗ Subject report failed with exit code $SUBJECT_EXIT"
    exit $SUBJECT_EXIT
fi
{% endif %}

# Always regenerate dataset report (progressive: includes all subjects completed so far)
python -m code.preprocessing.aggregate_reports --dataset

DATASET_EXIT=$?
if [ $DATASET_EXIT -eq 0 ]; then
    echo "✓ Dataset report generated successfully"
else
    echo "✗ Dataset report failed with exit code $DATASET_EXIT"
    exit $DATASET_EXIT
fi

{% endblock %}
